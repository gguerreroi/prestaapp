<%
const fmtQ = (n) => new Intl.NumberFormat('es-GT', { style:'currency', currency:'GTQ', maximumFractionDigits:0 }).format(Number(n||0));
const fmtD = (d) => d ? new Date(d).toLocaleDateString('es-GT', { timeZone:'America/Guatemala', year:'numeric', month:'2-digit', day:'2-digit' }) : '-';

const fullName = (c) => [c?.nombres, c?.apellidos].filter(Boolean).join(' ').trim();

const badgePrestamo = (st) => {
    st = (st || '').toUpperCase();
    if (st === 'PAGADO') return 'badge-light-success';
    if (st === 'ACTIVO') return 'badge-light-primary';
    if (st === 'ANULADO') return 'badge-light-secondary';
    return 'badge-light-warning';
};

const badgeCliente = (st) => {
    st = (st || '').toUpperCase();
    if (st === 'AC') return 'badge-light-success';
    if (st === 'IN') return 'badge-light-danger';
    if (st === 'BL') return 'badge-light-warning';
    return 'badge-light-secondary';
};

const clienteNombre = fullName(cliente);
const cuiCompleto = (cliente?.cui9 && cliente?.cui4) ? `${cliente.cui9}-${cliente.cui4}` : (cliente?.cui9 || '-');

%>

<!--begin::Toolbar-->
<div class="toolbar py-3 py-lg-6" id="kt_toolbar">
    <div class="container-xxl d-flex flex-stack flex-wrap gap-2">
        <div class="page-title d-flex flex-column justify-content-center me-3">
            <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                Cliente
            </h1>

            <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                <li class="breadcrumb-item text-muted">
                    <a href="/" class="text-muted text-hover-primary">Inicio</a>
                </li>
                <li class="breadcrumb-item">
                    <span class="bullet bg-gray-400 w-5px h-2px"></span>
                </li>
                <li class="breadcrumb-item text-muted">
                    <a href="/clientes" class="text-muted text-hover-primary">Clientes</a>
                </li>
                <li class="breadcrumb-item">
                    <span class="bullet bg-gray-400 w-5px h-2px"></span>
                </li>
                <li class="breadcrumb-item text-dark">Detalle</li>
            </ul>
        </div>


        <div class="d-flex align-items-center gap-2 gap-lg-3">
            <a href="/clientes" class="btn btn-light">Volver</a>
            <a href="/prestamos/nuevo?cui9=<%= cliente?.cui9 || '' %>" class="btn btn-primary">Nuevo préstamo</a>
            <button type="button" class="btn btn-light-primary" data-bs-toggle="modal" data-bs-target="#kt_modal_cliente_edit">
                Editar cliente
            </button>
            <span class="badge <%= badgeCliente(cliente?._estado) %>">
            <%= (cliente?._estado || '—') %>
            </span>
        </div>
    </div>
</div>
<!--end::Toolbar-->

<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <div class="container-xxl" id="kt_content_container">

        <div class="row g-5 g-xl-8">

            <!-- Left: Perfil -->
            <div class="col-12 col-xl-4">

                <!-- Perfil -->
                <div class="card gc-elevated mb-5">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="symbol symbol-50px symbol-circle me-4">
                                <div class="symbol-label bg-light-primary text-primary fw-bolder fs-3">
                                    <%= (clienteNombre?.[0] || 'C').toUpperCase() %>
                                </div>
                            </div>

                            <div class="flex-grow-1">
                                <div class="fw-bolder fs-4 text-gray-900"><%= clienteNombre || '—' %></div>
                                <div class="text-muted">CUI: <span class="fw-semibold"><%= cuiCompleto %></span></div>
                            </div>
                        </div>

                        <div class="separator my-6"></div>

                        <div class="d-flex flex-column gap-4">
                            <div>
                                <div class="text-muted fs-7">Teléfono</div>
                                <div class="fw-semibold text-gray-900"><%= cliente?.telefono || '—' %></div>
                            </div>

                            <div>
                                <div class="text-muted fs-7">Dirección</div>
                                <div class="fw-semibold text-gray-900"><%= cliente?.direccion || '—' %></div>
                            </div>

                            <div>
                                <div class="text-muted fs-7">Agente (cartera)</div>
                                <div class="fw-semibold text-gray-900"><%= cliente?.cartera_nombre || '—' %></div>
                            </div>

                            <div>
                                <div class="text-muted fs-7">Referencias de vivienda</div>
                                <div class="fw-semibold text-gray-900"><%= cliente?.referencias_vivienda || '—' %></div>
                            </div>

                            <div>
                                <div class="text-muted fs-7">Observaciones</div>
                                <div class="fw-semibold text-gray-900"><%= cliente?.observaciones || '—' %></div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-muted fs-7">Creado</div>
                                    <div class="fw-semibold"><%= fmtD(cliente?._creado) %></div>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted fs-7">Actualizado</div>
                                    <div class="fw-semibold"><%= fmtD(cliente?._modificado) %></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Fotos -->
                <div class="card gc-elevated">
                    <div class="card-header">
                        <div class="card-title">
                            <h3 class="fw-bold m-0">Fotografías</h3>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row g-4">
                            <% const fotos = [
                                { label:'CUI frontal', url: cliente?.img_cui_frontal_url },
                                { label:'CUI dorsal', url: cliente?.img_cui_dorsal_url },
                                { label:'Vivienda', url: cliente?.img_vivienda_url },
                                { label:'Persona', url: cliente?.img_persona_url },
                            ]; %>

                            <% fotos.forEach((f) => { %>
                                <div class="col-12 col-md-6 col-xl-12">
                                    <div class="border rounded p-3">
                                        <div class="text-muted fs-7 mb-2"><%= f.label %></div>

                                        <% if (f.url) { %>
                                            <a href="<%= f.url %>" target="_blank" class="d-block">
                                                <img src="<%= f.url %>" alt="<%= f.label %>" class="w-100 rounded" style="max-height:180px; object-fit:cover;">
                                            </a>
                                        <% } else { %>
                                            <div class="text-muted fs-7">No cargada</div>
                                        <% } %>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right: Métricas + Préstamos -->
            <div class="col-12 col-xl-8">

                <!-- Métricas -->
                <div class="row g-5 mb-5">
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card gc-elevated">
                            <div class="card-body">
                                <div class="text-muted fs-7">Préstamos</div>
                                <div class="fs-2 fw-bolder"><%= resumen?.prestamos_totales ?? 0 %></div>
                                <div class="text-muted fs-8">Activos: <span class="fw-bold"><%= resumen?.prestamos_activos ?? 0 %></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card gc-elevated">
                            <div class="card-body">
                                <div class="text-muted fs-7">Saldo total</div>
                                <div class="fs-2 fw-bolder"><%= fmtQ(resumen?.saldo_total || 0) %></div>
                                <div class="text-muted fs-8">Mora: <span class="fw-bold"><%= fmtQ(resumen?.total_mora_total || 0) %></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card gc-elevated">
                            <div class="card-body">
                                <div class="text-muted fs-7">Pagado</div>
                                <div class="fs-2 fw-bolder"><%= fmtQ(resumen?.total_pagado_total || 0) %></div>
                                <div class="text-muted fs-8">Total: <span class="fw-bold"><%= fmtQ(resumen?.total_pagar_total || 0) %></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card gc-elevated">
                            <div class="card-body">
                                <div class="text-muted fs-7">Atrasos</div>
                                <div class="fs-2 fw-bolder"><%= resumen?.cuotas_atrasadas_total ?? 0 %></div>
                                <div class="text-muted fs-8">Cuotas atrasadas</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Listado de préstamos -->
                <div class="card gc-elevated">
                    <div class="card-header">
                        <div class="card-title">
                            <h3 class="fw-bold m-0">Préstamos del cliente</h3>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3">
                                <thead>
                                <tr class="fw-bold text-muted">
                                    <th class="min-w-90px">ID</th>
                                    <th class="min-w-140px">Inicio</th>
                                    <th class="min-w-120px text-end">Principal</th>
                                    <th class="min-w-120px text-end">Pagado</th>
                                    <th class="min-w-120px text-end">Saldo</th>
                                    <th class="min-w-120px text-center">Atrasos</th>
                                    <th class="min-w-120px">Estado</th>
                                    <th class="min-w-120px text-end">Acción</th>
                                </tr>
                                </thead>

                                <tbody>
                                <% if (!prestamos || prestamos.length === 0) { %>
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-10">
                                            No hay préstamos registrados para este cliente.
                                        </td>
                                    </tr>
                                <% } else { %>
                                    <% prestamos.forEach((p) => { %>
                                        <tr>
                                            <td class="fw-bold text-gray-800">#<%= p.prestamo_id %></td>
                                            <td><%= fmtD(p.fecha_inicio) %></td>
                                            <td class="text-end fw-bold"><%= fmtQ(p.principal) %></td>
                                            <td class="text-end"><%= fmtQ(p.total_pagado) %></td>
                                            <td class="text-end fw-bold"><%= fmtQ(p.saldo) %></td>
                                            <td class="text-center">
                                                <% if ((p.cuotas_atrasadas || 0) > 0) { %>
                                                    <span class="badge gc-late"><%= p.cuotas_atrasadas %></span>
                                                <% } else { %>
                                                    <span class="text-muted">0</span>
                                                <% } %>
                                            </td>
                                            <td>
                          <span class="badge <%= badgePrestamo(p.estado) %> text-uppercase">
                            <%= p.estado %>
                          </span>
                                            </td>
                                            <td class="text-end">
                                                <a href="/prestamos/<%= p.prestamo_id %>" class="btn btn-sm btn-light-primary">
                                                    Ver
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } %>
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>

<!--begin::Modal - Edit Cliente-->
<div class="modal fade" id="kt_modal_cliente_edit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Editar cliente</h2>

                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal" aria-label="Close">
          <span class="svg-icon svg-icon-1">
            <!-- icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path opacity="0.3" d="M6 19.7L19.7 6c.4-.4.4-1 0-1.4l-.3-.3c-.4-.4-1-.4-1.4 0L4.3 17.9c-.1.1-.2.3-.2.5l-.2 1.7c0 .3.3.6.6.6l1.7-.2c.2 0 .4-.1.5-.2z" fill="currentColor"/>
              <path d="M5.6 18.8l-.1 1.1 1.1-.1L19 7.4 17.6 6 5.6 18.8z" fill="currentColor"/>
            </svg>
          </span>
                </div>
            </div>

            <div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
                <form id="formClienteEdit" class="form" novalidate>
                    <input type="hidden" id="edit_cui9" name="cui9" value="<%= cliente?.cui9 || '' %>">

                    <div class="mb-5">
                        <label class="form-label fw-semibold">CUI</label>
                        <input class="form-control form-control-solid" value="<%= cuiCompleto %>" disabled>
                        <div class="form-text">El CUI no se puede modificar.</div>
                    </div>

                    <div class="row g-5 mb-5">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="edit_nombres">Nombres</label>
                            <input id="edit_nombres" name="nombres" class="form-control form-control-lg" value="<%= cliente?.nombres || '' %>" required>
                            <div class="text-danger fs-7 mt-1" id="edit_nombres_error"></div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="edit_apellidos">Apellidos</label>
                            <input id="edit_apellidos" name="apellidos" class="form-control form-control-lg" value="<%= cliente?.apellidos || '' %>" required>
                            <div class="text-danger fs-7 mt-1" id="edit_apellidos_error"></div>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-semibold" for="edit_direccion">Dirección</label>
                        <input id="edit_direccion" name="direccion" class="form-control form-control-lg" value="<%= cliente?.direccion || '' %>">
                    </div>

                    <div class="row g-5 mb-5">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="edit_telefono">Teléfono</label>
                            <input id="edit_telefono" name="telefono" class="form-control form-control-lg" value="<%= cliente?.telefono || '' %>" inputmode="tel">
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold" for="edit_cartera_id">Cartera (agente)</label>
                            <select id="edit_cartera_id" name="cartera_id" class="form-select form-select-lg">
                                <option value="">Seleccione…</option>
                            </select>
                            <div class="form-text"></div>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-semibold" for="edit_referencias_vivienda">Referencias de vivienda</label>
                        <input id="edit_referencias_vivienda" name="referencias_vivienda" class="form-control form-control-lg" value="<%= cliente?.referencias_vivienda || '' %>">
                    </div>

                    <div class="mb-7">
                        <label class="form-label fw-semibold" for="edit_observaciones">Observaciones</label>
                        <textarea id="edit_observaciones" name="observaciones" class="form-control form-control-lg" rows="3"><%= cliente?.observaciones || '' %></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>

                        <button type="submit" id="btnSaveCliente" class="btn btn-primary">
                            <span class="indicator-label">Guardar cambios</span>
                            <span class="indicator-progress">
                Guardando...
                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
              </span>
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<!--end::Modal - Edit Cliente-->
<script>
    window.__CARTERA_ID__ = "<%- cliente.cartera_id %>"
    window.__CARTERA_NOMBRE__ = "<%- cliente.cartera_nombre %>"
</script>